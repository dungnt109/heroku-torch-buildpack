BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
LD_LIBRARY_PATH:/app/luajit/lib

PATH=/sbin:/app/torch/bin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/bin:/usr/local/bin:/bin
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build step

echo 'Making sure /app/torch exists...'
mkdir -p $BUILD_DIR/torch

echo "Switching to the $BUILD_DIR directory..."
cd $BUILD_DIR

echo 'Installing cmake...'
curl -O 'https://cmake.org/files/v3.7/cmake-3.7.1.tar.gz'
tar zxf cmake-3.7.1.tar.gz
cd cmake-3.7.1
./bootstrap --prefix=$BUILD_DIR/torch
make
make install

echo 'Fetching luajit and luarocks...'
git clone https://github.com/torch/luajit-rocks.git
cd luajit-rocks
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=$BUILD_DIR/torch
make install

mkdir -p $BUILD_DIR/.profile.d
echo "PATH="$PATH > $BUILD_DIR/.profile.d/lua.sh  
echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$BUILD_DIR/torch/lib" >> $BUILD_DIR/.profile.d/lua.sh
