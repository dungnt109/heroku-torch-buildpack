BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
LD_LIBRARY_PATH:$CACHE_DIR/torch/lib

PATH=/sbin:/app/torch/bin:/app/torch/sbin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/bin:/usr/local/bin:/bin
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build step

rm -rf $CACHE_DIR/cmake-3.7.1*
rm -rf $CACHE_DIR/luajit-rocks

echo "Making sure $CACHE_DIR/torch exists..."
mkdir -p $CACHE_DIR/torch

echo "Switching to the $CACHE_DIR directory..."
cd $CACHE_DIR

echo 'Checking to see if cmake is fetched....'
if hash cmake 2>/dev/null; then
  echo 'cmake is installed, skipping...'
else
  echo 'Installing cmake...'
  curl -O 'https://cmake.org/files/v3.7/cmake-3.7.1.tar.gz'
  tar zxf cmake-3.7.1.tar.gz

  echo 'Building cmake...'
  cd cmake-3.7.1
  ./bootstrap --prefix=/app/torch
  make
fi

echo "Switching to the $CACHE_DIR/cmake-3.7.1 directory..."
cd $CACHE_DIR/cmake-3.7.1
echo 'Installing cmake...'
make install

echo "Switching to the $CACHE_DIR directory..."
cd $CACHE_DIR
echo 'Checking to see if luajit and luarocks are fetched....'
if [ -d "$CACHE_DIR/luajit-rocks" ]; then
  echo 'luajit and luarocks are fetched, skipping...'
else
  echo 'Fetching luajit and luarocks...'
  git clone https://github.com/torch/luajit-rocks.git
fi

if [ ! -d "$CACHE_DIR/luajit-rocks/build" ]; then
  echo 'Building luajit and luarocks...'
  cd $CACHE_DIR/luajit-rocks
  mkdir build
  cd build
  cmake .. -DCMAKE_INSTALL_PREFIX=/app/torch
fi

echo "Switching to the $CACHE_DIR/luajit-rocks/build directory..."
cd $CACHE_DIR/luajit-rocks/build
echo 'Installing luajit and luarocks...'
make install

echo "Switching to the $BUILD_DIR directory..."
cd $BUILD_DIR

mkdir -p $BUILD_DIR/.profile.d
echo "PATH="$PATH > $BUILD_DIR/.profile.d/lua.sh

echo "Checking to see if $BUILD_DIR/setup.sh exists..."
if [ -f "$BUILD_DIR/setup.sh" ]; then
  echo "Running \`sh $BUILD_DIR/setup.sh\`..."
  sh setup.sh
fi
