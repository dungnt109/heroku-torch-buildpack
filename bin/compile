BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
LD_LIBRARY_PATH:$CACHE_DIR/torch/lib

PATH=/sbin:$BUILD_DIR/torch/bin:$BUILD_DIR/torch/sbin:$CACHE_DIR/torch/bin:$CACHE_DIR/torch/sbin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/bin:/usr/local/bin:/bin
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build step

echo "Making sure $CACHE_DIR/torch exists..."
mkdir -p $CACHE_DIR/torch

echo "Switching to the $CACHE_DIR directory..."
cd $CACHE_DIR

echo 'Checking to see if cmake is installed....'
if hash cmake 2>/dev/null; then
  echo 'cmake is installed, skipping...'
else
  echo 'Installing cmake...'
  curl -O 'https://cmake.org/files/v3.7/cmake-3.7.1.tar.gz'
  tar zxf cmake-3.7.1.tar.gz
  cd cmake-3.7.1
  ./bootstrap --prefix=$CACHE_DIR/torch
  make
  make install
fi

echo 'Checking to see if luajit and luarocks are installed....'
if hash luarocks 2>/dev/null; then
  echo 'luajit and luarocks are installed, skipping...'
else
  echo 'Fetching luajit and luarocks...'
  git clone https://github.com/torch/luajit-rocks.git
  cd luajit-rocks
  mkdir build
  cd build
  cmake .. -DCMAKE_INSTALL_PREFIX=$CACHE_DIR/torch
  make install
fi

echo "Switching to the $BUILD_DIR directory..."
cd $BUILD_DIR

echo "Making sure $CACHE_DIR/torch/share/lua/5.1 directory exists..."
mkdir -p $CACHE_DIR/torch/share/lua/5.1

mkdir -p $BUILD_DIR/.profile.d
echo "PATH="$PATH > $BUILD_DIR/.profile.d/lua.sh
# echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:$CACHE_DIR/torch/lib" >> $BUILD_DIR/.profile.d/lua.sh
echo "export LUA_PATH=$CACHE_DIR/torch/share/lua/5.1/?.lua;$CACHE_DIR/torch/share/lua/5.1/?/init.lua;\$LUA_PATH" >> $BUILD_DIR/.profile.d/lua.sh
echo "export LUA_CPATH=$CACHE_DIR/torch/share/lua/5.1/?.so;\$LUA_CPATH" >> $BUILD_DIR/.profile.d/lua.sh

. $BUILD_DIR/.profile.d/lua.sh
env
# echo '---'
# echo "PATH is $PATH"
# echo '---'
# echo "LD_LIBRARY_PATH is $LD_LIBRARY_PATH"
# echo '---'
# echo "LUA_PATH is $LUA_PATH"
# echo '---'
# echo "LUA_CPATH is $LUA_CPATH"
# echo '---'

echo "Checking to see if $BUILD_DIR/setup.sh exists..."
if [ -f "$BUILD_DIR/setup.sh" ]; then
  echo "Running \`sh $BUILD_DIR/setup.sh\`..."
  sh setup.sh
fi
